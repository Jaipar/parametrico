---
title: "shapes"
output: html_document
date: "2025-06-14"
---

```{r Librerías}
# Manejo y análisis de datos geoespaciales (vectores)
library(sf)

# Visualización temática de datos espaciales (mapas estáticos y dinámicos)
library(tmap)

# Manipulación y transformación de datos (data frames y tibbles)
library(dplyr)

# Visualización interactiva de mapas web (basados en Leaflet.js)
library(leaflet)

# Creación de gráficos estáticos y personalizados (gramática de gráficos)
library(ggplot2)

# Enlace con servidores CHIRPS
library(chirps)

# Tratamiento de fechas
library(lubridate)

# Imágenes estáticas para gráficos
library(tmap)
tmap_mode("plot")

# Paletas de colores para gráficos
library(RColorBrewer)
```

```{r Cargar}
# Cargar polígono con regiones cafetaleras
regiones <- st_read("Distribucion_regiones_cafetaleras.shp")

# Cargar polígono con cobertura cafetalera 2017 - 2018
cobertura <- st_read("Cobertura_cafe_2017-2018.shp")

# Establecer sistema de coordenadas
regiones <- st_set_crs(regiones, 5367) # EPSG 5367 = CRTM05
cobertura <- st_set_crs(cobertura, 5367) # EPSG 5367 = CRTM05

# Transformar sistemas de coordenadas
regiones <- st_transform(regiones, 4326)
cobertura <- st_transform(cobertura, 4326)

# Intentar corregir geometrías inválidas
#   Reparar auto-intersecciones:
#     Si un polígono se cruza a sí mismo, la función puede dividirlo en partes
#     válidas o recortarlo para eliminar las intersecciones.
#   Eliminar vértices duplicados:
#     Borra puntos consecutivos idénticos o muy cercanos que no aportan nada.
#   Cerrar anillos abiertos:
#     Si un anillo no está cerrado (el último punto no coincide con el primero),
#     la función lo cierra automáticamente.
#   Separar polígonos multi-parte mal formados:
#     En caso de que geometrías compuestas o multi-polígonos
#     presenten problemas, se les separa en partes válidas.
#   Corregir orientación de anillos:
#     Puede ajustar la dirección en la que están ordenados los vértices
#     para cumplir las convenciones.
if (any(!st_is_valid(regiones))) {
  regiones <- st_make_valid(regiones)
}
if (any(!st_is_valid(cobertura))) {
  cobertura <- st_make_valid(cobertura)
}
```

```{r Filtrar}
# Agregar etiqueta con número de región
regiones <- regiones %>% mutate(etiqueta = paste("Región", row_number()))

# Región Norte
region_norte <- regiones %>% filter(etiqueta == "Región 5")

# Región Los Santos
region_santos <- regiones %>% filter(etiqueta == "Región 2")

# Encontrar fincas que están dentro de la zona cafetalera Norte
cobertura_norte <- cobertura[
  st_within(cobertura, region_norte, sparse = FALSE)[, 1],
]

# Encontrar fincas que están dentro de la zona cafetalera Los Santos
cobertura_santos <- cobertura[
  st_within(cobertura, region_santos, sparse = FALSE)[, 1],
]

# Rectángulo que contiene toda la cobertura en la zona cafetalera Norte
rectangulo_norte <- st_bbox(cobertura_norte)

# Rectángulo que contiene toda la cobertura en la zona cafetalera Los Santos
rectangulo_santos <- st_bbox(cobertura_santos)

# Rectángulo (Norte) convertido en polígono para gráficos
rectangulo_norte2 <- st_as_sfc(rectangulo_norte)

# Rectángulo (Los Santos) convertido en polígono para gráficos
rectangulo_santos2 <- st_as_sfc(rectangulo_santos)

# Área en hectáreas de las fincas Norte
area_norte <-
  as.numeric(st_area(st_transform(cobertura_norte, 5367))) / 10000

# Área en hectáreas de las fincas Los Santos
area_santos <-
  as.numeric(st_area(st_transform(cobertura_santos, 5367))) / 10000

# Centroides de las fincas Norte
centroides_norte <- st_centroid(cobertura_norte)

# Centroides de las fincas Los Santos
centroides_santos <- st_centroid(cobertura_santos)

# Coordenadas de los centroides en fincas Norte
centroides_norte <-
  cbind(
    centroides_norte,
    as.data.frame(st_coordinates(centroides_norte)) %>%
      rename("lon" = 1, "lat" = 2)
  ) %>%
  mutate(area = area_norte)

# Coordenadas de los centroides en fincas Los Santos
centroides_santos <-
  cbind(
    centroides_santos,
    as.data.frame(st_coordinates(centroides_santos)) %>%
      rename("lon" = 1, "lat" = 2)
  ) %>%
  mutate(area = area_santos)

# Redondear al múltiplo de 0.05 más cercano (comparten misma resolución)
centroides_norte <-
  centroides_norte %>%
  mutate(
    lon_round = round(lon / 0.05) * 0.05,
    lat_round = round(lat / 0.05) * 0.05
  )

resumen_coords_norte <-
  centroides_norte %>%
  group_by(lon_round, lat_round) %>%
  summarise(n_fincas = n(), area = sum(area), .groups = "drop") %>%
  rename("lon" = 1, "lat" = 2)

centroides_santos <-
  centroides_santos %>%
  mutate(
    lon_round = round(lon / 0.05) * 0.05,
    lat_round = round(lat / 0.05) * 0.05
  )

resumen_coords_santos <-
  centroides_santos %>%
  group_by(lon_round, lat_round) %>%
  summarise(n_fincas = n(), area = sum(area), .groups = "drop") %>%
  rename("lon" = 1, "lat" = 2)
```


```{r CHIRPS}
# Descargar información CHIRPS región Norte
lista_anual_norte <- list()

for (x_anno in 1:21) {
  lista_anual_norte[[x_anno]] <-
    get_chirps(resumen_coords_norte %>% select(lon, lat),
      dates = c(
        paste0(x_anno + 2004 - 1, "-01-01"),
        paste0(x_anno + 2004 - 1, "-12-31")
      ),
      server = "ClimateSERV"
    )
}
names(lista_anual_norte) <- "2004":"2024"

# Descargar información CHIRPS región Los Santos
lista_anual_santos <- list()

for (x_anno in 1:21) {
  lista_anual_santos[[x_anno]] <-
    get_chirps(resumen_coords_santos %>% select(lon, lat),
      dates = c(
        paste0(x_anno + 2004 - 1, "-01-01"),
        paste0(x_anno + 2004 - 1, "-12-31")
      ),
      server = "ClimateSERV"
    )
}

names(lista_anual_santos) <- "2004":"2024"



leaflet(grids_santos) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    fillColor = "orange",
    fillOpacity = 0.6,
    color = "black",
    weight = 1,
    label = ~ paste(n_fincas, "fincas")
  )




precipitaciones <- get_chirps(resumen_coords,
  dates = c("2022-01-01", "2022-12-31"),
  server = "ClimateSERV"
)

precipitaciones %>%
  group_by(lat, lon) %>%
  summarise(total_precip = sum(chirps, na.rm = TRUE), .groups = "drop")


precipitaciones %>%
  group_by(lat, lon) %>%
  summarise(total_precip = sum(chirps, na.rm = TRUE), .groups = "drop") %>%
  leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircles(
    lng = ~lon,
    lat = ~lat,
    weight = 1,
    radius = 1000,
    color = ~ colorNumeric("YlGnBu", total_precip)(total_precip),
    fillOpacity = 0.7,
    label = ~ paste("Precipitación total:", round(total_precip, 2), "mm")
  )

leaflet() %>%
  addTiles() %>%
  addPolygons(data = rectangulo_santos2, color = "blue", fillOpacity = 0.05) %>%
  addPolygons(data = cobertura_santos, color = "green", fillOpacity = 0.3)


leaflet() %>%
  addTiles() %>%
  addPolygons(data = rectangulo_norte2, color = "blue", fillOpacity = 0.05) %>%
  addPolygons(data = cobertura_norte, color = "green", fillOpacity = 0.3)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = fincas_santos,
    fillColor = "green",
    fillOpacity = 0.4,
    color = "black"
  )
```

```{r Promedios}
# Precipitación promedio anual por píxel de cada región
chirps_prom_norte <- bind_rows(lista_anual_norte, .id = "year") %>%
  group_by(year, lon, lat) %>%
  summarise(precip_anual = sum(chirps), .groups = "drop") %>%
  group_by(lon, lat) %>%
  summarise(
    precip_anual_prom = mean(precip_anual, na.rm = TRUE),
    .groups = "drop"
  )

chirps_prom_santos <- bind_rows(lista_anual_santos, .id = "year") %>%
  group_by(year, lon, lat) %>%
  summarise(precip_anual = sum(chirps), .groups = "drop") %>%
  group_by(lon, lat) %>%
  summarise(
    precip_anual_prom = mean(precip_anual, na.rm = TRUE),
    .groups = "drop"
  )

# Unir datos para Norte
resumen_coords_norte <- resumen_coords_norte %>%
  left_join(chirps_prom_norte, by = c("lon", "lat"))

# Unir datos para Los Santos
resumen_coords_santos <- resumen_coords_santos %>%
  left_join(chirps_prom_santos, by = c("lon", "lat"))

# Crear cuadriculas de las zonas cafetaleras
grids_norte <-
  resumen_coords_norte %>%
  rowwise() %>%
  mutate(
    geometry = list(
      st_polygon(list(matrix(
        c(
          lon - 0.025, lat - 0.025,
          lon + 0.025, lat - 0.025,
          lon + 0.025, lat + 0.025,
          lon - 0.025, lat + 0.025,
          lon - 0.025, lat - 0.025
        ),
        ncol = 2,
        byrow = TRUE
      )))
    )
  ) %>%
  ungroup() %>%
  st_as_sf(crs = 4326, sf_column_name = "geometry")

grids_santos <-
  resumen_coords_santos %>%
  rowwise() %>%
  mutate(
    geometry = list(
      st_polygon(list(matrix(
        c(
          lon - 0.025, lat - 0.025,
          lon + 0.025, lat - 0.025,
          lon + 0.025, lat + 0.025,
          lon - 0.025, lat + 0.025,
          lon - 0.025, lat - 0.025
        ),
        ncol = 2,
        byrow = TRUE
      )))
    )
  ) %>%
  ungroup() %>%
  st_as_sf(crs = 4326, sf_column_name = "geometry")
```

```{r graphs promedios}
pal_comun <- colorNumeric(
  "Blues",
  domain = c(grids_santos$precip_anual_prom, grids_norte$precip_anual_prom)
)

rango_comun <- range(
  c(grids_norte$precip_anual_prom, grids_santos$precip_anual_prom),
  na.rm = TRUE
)

leaflet(grids_santos) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    fillColor = ~ pal_comun(precip_anual_prom),
    fillOpacity = 0.7,
    color = "gray",
    weight = 1,
    label = ~ paste0(
      "Lluvia: ", round(precip_anual_prom, 1), " mm\n",
      "Área: ", round(area, 1), " ha\n",
      "Fincas: ", n_fincas
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal_comun,
    values = rango_comun,
    title = "Precipitación anual promedio (mm)"
  )

leaflet(grids_norte) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    fillColor = ~ pal_comun(precip_anual_prom),
    fillOpacity = 0.7,
    color = "gray",
    weight = 1,
    label = ~ paste0(
      "Lluvia: ", round(precip_anual_prom, 1), " mm\n",
      "Área: ", round(area, 1), " ha\n",
      "Fincas: ", n_fincas
    )
  ) %>%
  addPolygons(
    data = cobertura_norte,
    fillColor = "green",
    fillOpacity = 0.15,
    color = "darkgreen",
    weight = 1
  ) %>%
  addLegend(
    "bottomright",
    pal = pal_comun,
    values = rango_comun,
    title = "Precipitación anual promedio (mm)"
  )

map_norte <- tm_shape(grids_norte) +
  tm_polygons(
    fill = "precip_anual_prom",
    fill.scale = tm_scale(
      values = "brewer.blues",
      breaks = seq(1500, 4500, 500)
    ),
    fill.legend = tm_legend(title = "Lluvia (mm)")
  ) +
  tm_borders(lwd = 0.5) +
  tm_title("Región Norte")

map_santos <- tm_shape(grids_santos) +
  tm_polygons(
    fill = "precip_anual_prom",
    fill.scale = tm_scale(
      values = "brewer.blues",
      breaks = seq(1500, 4500, 500)
    ),
    fill.legend = tm_legend(title = "Lluvia (mm)")
  ) +
  tm_borders(lwd = 0.5) +
  tm_title("Región Los Santos")

tmap_arrange(map_norte, map_santos, ncol = 2)
```

```{r graphs Norte}
# Paleta de color para fincas
pal_norte <- colorNumeric("YlOrRd", domain = grids_norte$n_fincas)

# Gráfico cantidad de fincas

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  # Cuadrantes CHIRPS
  addPolygons(
    data = grids_norte,
    fillColor = ~ pal_norte(n_fincas),
    fillOpacity = 0.7,
    color = "gray",
    weight = 1,
    label = ~ paste(n_fincas, "fincas")
  ) %>%
  # Polígonos (transparentes) de cobertura cafetalera
  addPolygons(
    data = cobertura_norte,
    fillColor = "green",
    fillOpacity = 0.2,
    color = "darkgreen",
    weight = 1
  ) %>%
  # Leyenda (número de fincas)
  addLegend(
    "bottomright",
    pal = pal_norte,
    values = grids_norte$n_fincas,
    title = "Cantidad de fincas"
  )

# Paleta de color para fincas
pal_norte <- colorNumeric("YlOrRd", domain = grids_norte$area)

# Gráfico área por cuadrícula

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  # Cuadrantes CHIRPS con color por área
  addPolygons(
    data = grids_norte,
    fillColor = ~ pal_norte(area),
    fillOpacity = 0.7,
    color = "gray",
    weight = 1,
    label = ~ paste0(round(area, 2), " ha")
  ) %>%
  # Capa de cobertura cafetalera Los Santos (transparente)
  addPolygons(
    data = cobertura_norte,
    fillColor = "green",
    fillOpacity = 0.2,
    color = "darkgreen",
    weight = 1
  ) %>%
  # Leyenda
  addLegend(
    "bottomright",
    pal = pal_norte,
    values = grids_norte$area,
    title = "Área total de cafetales (ha)"
  )
```


```{r graphs Los Santos}
# Paleta de color para fincas
pal_santos <- colorNumeric("YlOrRd", domain = grids_santos$n_fincas)

# Gráfico cantidad de fincas

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  # Cuadrantes CHIRPS
  addPolygons(
    data = grids_santos,
    fillColor = ~ pal_santos(n_fincas),
    fillOpacity = 0.7,
    color = "gray",
    weight = 1,
    label = ~ paste(n_fincas, "fincas")
  ) %>%
  # Polígonos (transparentes) de cobertura cafetalera
  addPolygons(
    data = cobertura_santos,
    fillColor = "green",
    fillOpacity = 0.2,
    color = "darkgreen",
    weight = 1
  ) %>%
  # Leyenda (número de fincas)
  addLegend(
    "bottomright",
    pal = pal_santos,
    values = grids_santos$n_fincas,
    title = "Cantidad de fincas"
  )

# Paleta de color para fincas
pal_santos <- colorNumeric("YlOrRd", domain = grids_santos$area)

# Gráfico área por cuadrícula

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  # Cuadrantes CHIRPS con color por área
  addPolygons(
    data = grids_santos,
    fillColor = ~ pal_santos(area),
    fillOpacity = 0.7,
    color = "gray",
    weight = 1,
    label = ~ paste0(round(area, 2), " ha")
  ) %>%
  # Capa de cobertura cafetalera Los Santos (transparente)
  addPolygons(
    data = cobertura_santos,
    fillColor = "green",
    fillOpacity = 0.2,
    color = "darkgreen",
    weight = 1
  ) %>%
  # Leyenda
  addLegend(
    "bottomright",
    pal = pal_santos,
    values = grids_santos$area,
    title = "Área total de cafetales (ha)"
  )
```


```{r graphs serie}
# Gráfico de serie de tiempo
pixel_norte <- resumen_coords_norte %>% slice_max(area, n = 1)
pixel_santos <- resumen_coords_santos %>% slice_max(area, n = 1)

prec_norte <- bind_rows(lista_anual_norte, .id = "año") %>%
  filter(lat == pixel_norte$lat, lon == pixel_norte$lon)

prec_santos <- bind_rows(lista_anual_santos, .id = "año") %>%
  filter(lat == pixel_santos$lat, lon == pixel_santos$lon)

prec_norte <- prec_norte %>%
  mutate(fecha = ymd(date), mes = floor_date(fecha, "month")) %>%
  group_by(mes) %>%
  summarise(precip_mm = sum(chirps), .groups = "drop") %>%
  mutate(region = "Norte")

prec_santos <- prec_santos %>%
  mutate(fecha = ymd(date), mes = floor_date(fecha, "month")) %>%
  group_by(mes) %>%
  summarise(precip_mm = sum(chirps), .groups = "drop") %>%
  mutate(region = "Los Santos")

serie_prec <- bind_rows(prec_norte, prec_santos)

ggplot(serie_prec, aes(x = mes, y = precip_mm, color = region)) +
  geom_line(linewidth = 0.8) +
  labs(x = "Fecha", y = "Precipitación (mm)", color = "Región") +
  theme_minimal()
```




```{r Preparar}
# Descargar serie temporal para la caja envolvente
chirps_data <- get_chirps(
  lat = mean(c(bounding_rect["ymin"], bounding_rect["ymax"])),
  lon = mean(c(bounding_rect["xmin"], bounding_rect["xmax"])),
  start_date = "2023-01-01",
  end_date = "2023-12-31",
  server = "CHC",
  as.matrix = FALSE
)



# Crear secuencia de coordenadas
longitudes <- seq(bounding_rect$xmin, bounding_rect$xmax, by = 0.05)
latitudes <- seq(bounding_rect$ymin, bounding_rect$ymax, by = 0.05)

longitudes
latitudes

# Case 1: return as a data.frame
dates <- c("2017-09-01", "2017-09-30")
lonlat <- data.frame(lon = c(-55.150, -55.199), lat = c(-2.851, -2.849))

r1 <- get_chirps(lonlat, dates, server = "CHC")
r1 %>%
  group_by(date) %>%
  summarise(restas = first(chirps) - last(chirps), .groups = "drop") %>%
  summarise(cero = sum(restas))
```

```{r}
trunc(c(-55.051, -55.049) / 0.05) * 0.05
round(c(-55.051, -55.049) / 0.05) * 0.05
```


